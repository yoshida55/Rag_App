# CSS/HTML & 汎用ベストプラクティス RAG システム仕様書 (v6.0 Final)

## 1. 概要

### 1.1 目的
デザインカンプから実装する際のコード（HTML/CSS等）および、社内マニュアルや備忘録など、あらゆる業務の「正解（ベストプラクティス）」を検索・登録・管理するRAGシステム。

### 1.2 主な機能
- **自然言語検索**: 「〜したい」「〜の手順」で検索し、AIが複数データを統合して回答
- **汎用登録**: コードだけでなく、テキストベースのマニュアルや手順書も登録可能
- **入力支援**: 箇条書きのメモをAIがMarkdown形式に自動整形
- **インライン編集**: 検索結果からその場で編集・画像追加・削除が可能
- **クラウド同期**: データ原本をGoogle Driveに保存し、データ消失を防ぐ

### 1.3 システム構成図

```
┌─ Streamlit Cloud（無料ホスティング）─────────────────────────┐
│                                                              │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐        │
│  │  ChromaDB   │   │ Gemini 3.0  │   │  Gemini     │        │
│  │ ベクトル検索 │   │    Pro      │   │ Embedding   │        │
│  │ (メモリ上)  │   │  AI回答生成  │   │ テキスト変換 │        │
│  └──────┬──────┘   └─────────────┘   └─────────────┘        │
│         │                                                    │
│         ↕ 起動時読込 / 登録時保存                             │
│  ┌─────────────────────────────────────┐                    │
│  │         Google Drive                │                    │
│  │   practices.json + images/          │                    │
│  │      （データ永続化）                │                    │
│  └─────────────────────────────────────┘                    │
└──────────────────────────────────────────────────────────────┘
              ↑              ↑              ↑
           🏠自宅         🏢会社         📱スマホ
           
         同じURL → 同じデータにアクセス
```

---

## 2. 技術スタック

| 項目 | 技術 | 備考 |
|------|------|------|
| フロントエンド | Streamlit | Pythonで簡単にWebアプリ作成 |
| ベクトルDB | ChromaDB | 起動時にJSONから生成（メモリ上） |
| Embedding | Gemini Embedding (text-embedding-004) | 無料、768次元 |
| LLM (回答生成) | **Gemini 3.0 Pro** | 高精度な回答生成 |
| LLM (整形用) | Gemini 2.0 Flash | 高速・低コスト |
| LLM (AIチェック) | Gemini 3.0 Flash | 誤字脱字・内容確認 |
| データ保存 | Google Drive | practices.json + 画像 |
| デプロイ | Streamlit Cloud | 無料枠 |

---

## 3. ディレクトリ構成

```
rag-best-practices/
├── app.py                    # メインアプリ（エントリーポイント）
├── requirements.txt          # 依存パッケージ
├── .env                      # APIキー（※.gitignoreで除外）
├── .gitignore
├── README.md
│
├── config/
│   ├── settings.py           # 設定値（カテゴリ定義等）
│   └── drive_utils.py        # Google Drive連携（Upload/Download）
│
├── data/
│   ├── practices.json        # 登録データ（Driveと同期するローカルキャッシュ）
│   ├── usage_log.json        # API使用状況ログ ← 追加
│   └── chroma_db/            # ChromaDB永続化データ（一時ファイル）
│
├── images/                   # 画像ファイル（Driveと同期）
│   └── (アップロード画像)
│
├── modules/
│   ├── __init__.py
│   ├── ai_formatter.py       # AI整形モジュール（Gemini 2.0 Flash）
│   ├── ai_checker.py         # AIチェックモジュール（Gemini 3.0 Flash）← 追加
│   ├── database.py           # ChromaDB操作
│   ├── embedding.py          # Gemini Embedding
│   ├── llm.py                # Gemini 3.0 Pro呼び出し
│   ├── usage_tracker.py      # API使用状況トラッカー ← 追加
│   └── utils.py              # ユーティリティ関数
│
└── pages/
    ├── 1_🔍_検索.py          # 検索ページ（メイン・インライン編集）
    ├── 2_📝_登録.py          # 登録ページ（AI整形・AIチェック機能付き）
    ├── 3_📋_一覧.py          # データ一覧ページ
    └── 4_⚙️_設定.py          # 使用状況・設定ページ ← 追加
```

---

## 4. データ構造

### 4.1 practices.json

コード系とマニュアル系を統合管理。`content_type` で表示を切り替え。

```json
{
  "practices": [
    {
      "id": "uuid-v4",
      "title": "Flexboxカードレイアウト（均等配置）",
      "category": "html_css",
      "content_type": "code",
      "description": "カードを横並びで均等に配置する方法。gapプロパティで余白を管理し、flex: 1で均等幅に。",
      "tags": ["flexbox", "card", "gap", "responsive"],
      "code_html": "<div class=\"cards\">...</div>",
      "code_css": ".cards { display: flex; gap: 20px; }",
      "code_js": "",
      "image_path": "images/card-layout.png",
      "notes": "IE非対応。古いブラウザではmarginで代用。",
      "created_at": "2025-12-27T10:00:00",
      "updated_at": "2025-12-27T10:00:00"
    },
    {
      "id": "uuid-v4",
      "title": "本社へのアクセス方法",
      "category": "other",
      "content_type": "manual",
      "description": "## ルート案内\n1. 改札を出て右へ\n2. **郵便局**を目印に左折\n3. 徒歩3分で到着",
      "tags": ["access", "map", "マニュアル"],
      "code_html": null,
      "code_css": null,
      "code_js": null,
      "image_path": "images/access-map.png",
      "notes": "",
      "created_at": "2025-12-27T10:00:00",
      "updated_at": "2025-12-27T10:00:00"
    }
  ]
}
```

### 4.2 content_type による表示切り替え

| content_type | 表示形式 |
|--------------|----------|
| `code` | 画像 + コードブロック + 説明 |
| `manual` | 説明文（Markdown）を全幅表示、コード欄なし |

### 4.3 カテゴリ定義

```python
CATEGORIES = {
    "html_css": "HTML/CSS",
    "javascript": "JavaScript",
    "python": "Python",
    "gas": "Google Apps Script",
    "vba": "VBA",
    "other": "その他・マニュアル"
}
```

### 4.4 usage_log.json（API使用状況ログ）

```json
{
  "2025-12": {
    "gemini_3_pro": {
      "count": 42,
      "tokens_in": 84000,
      "tokens_out": 21000,
      "cost_yen": 63
    },
    "gemini_3_flash": {
      "count": 12,
      "tokens_in": 18000,
      "tokens_out": 6000,
      "cost_yen": 1
    },
    "gemini_2_flash": {
      "count": 15,
      "tokens_in": 15000,
      "tokens_out": 7500,
      "cost_yen": 2
    },
    "embedding": {
      "count": 57,
      "tokens": 28500,
      "cost_yen": 0
    }
  },
  "2025-11": {
    // 過去月のデータ
  }
}
```

---

## 5. 画面仕様

### 5.1 検索ページ（メイン）

カテゴリフィルタ + 可変レイアウト + インライン編集機能

```
┌─────────────────────────────────────────────────────────────┐
│  🎨 CSS/HTML ベストプラクティス RAG                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📁 カテゴリ:                                               │
│  [●] HTML/CSS  [ ] JavaScript  [ ] Python  [ ] GAS  [ ] 全て│
│                                                             │
│  🔍 検索:                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 横並びのカードを均等に配置したい                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                              [🔍 検索]     │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  🤖 AIの回答（Gemini 3.0 Pro）                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 横並びのカードを均等に配置するには、                  │   │
│  │ `display: flex` と `gap` の組み合わせがベストです。   │   │
│  │                                                     │   │
│  │ 親要素に `display: flex; gap: 20px;` を設定し、      │   │
│  │ 子要素（カード）に `flex: 1;` を指定すると均等幅に。  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  📚 参考データ（3件）                                       │
│  ［以下、検索結果カード］                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 検索結果カード（content_type: code の場合）

```
┌─────────────────────────────────────────────────────────────┐
│  ┌─────────────┐                                           │
│  │   [画像]    │  📌 Flexboxカードレイアウト（均等配置）    │
│  │             │  タグ: flexbox, card, gap                 │
│  └─────────────┘                                           │
│                                                             │
│  説明: カードを横並びで均等に配置する方法...                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ .cards {                                            │   │
│  │   display: flex;                                    │   │
│  │   gap: 20px;                                        │   │
│  │ }                                       [📋 Copy]   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [✏️ 編集] [🖼️ 画像追加] [🗑️ 削除]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 検索結果カード（content_type: manual の場合）

```
┌─────────────────────────────────────────────────────────────┐
│  📄 本社へのアクセス方法                                    │
│  タグ: access, map, マニュアル                              │
│  ───────────────────────────────────────────────────────── │
│                                                             │
│  ## ルート案内                                              │
│  1. 改札を出て右へ                                         │
│  2. **郵便局**を目印に左折                                  │
│  3. 徒歩3分で到着                                          │
│                                                             │
│  [画像: access-map.png]                                     │
│                                                             │
│  [✏️ 編集] [🖼️ 画像追加] [🗑️ 削除]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 インライン編集モード（✏️ 編集ボタン押下時）

```
┌─────────────────────────────────────────────────────────────┐
│  ✏️ 編集モード                                   [❌ 閉じる]│
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  タイトル *                                         │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ Flexboxカードレイアウト（均等配置）            │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  カテゴリ *                                         │   │
│  │  [ HTML/CSS ▼ ]                                     │   │
│  │                                                     │   │
│  │  説明文 *                                           │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ カードを横並びで均等に配置する方法。           │ │   │
│  │  │ gapプロパティで余白を管理し...                 │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │  [ ✨ AIでMarkdownに整形 ]                          │   │
│  │                                                     │   │
│  │  タグ（カンマ区切り）                               │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ flexbox, card, gap, responsive                │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  CSSコード                                          │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ .cards {                                      │ │   │
│  │  │   display: flex;                              │ │   │
│  │  │   gap: 20px;                                  │ │   │
│  │  │ }                                             │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  [💾 保存] [キャンセル]                             │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.5 画像追加ダイアログ（🖼️ 画像追加ボタン押下時）

```
┌─────────────────────────────────────────────────────────────┐
│  🖼️ 画像追加                                     [❌ 閉じる]│
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  現在の画像:                                        │   │
│  │  ┌─────────────────┐                               │   │
│  │  │   [サムネイル]   │  card-layout.png             │   │
│  │  └─────────────────┘  [🗑️ 画像を削除]             │   │
│  │                                                     │   │
│  │  新しい画像をアップロード:                          │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │  📁 ファイルをドラッグ or クリック           │   │   │
│  │  │     PNG, JPG, GIF（最大5MB）                 │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  │                                                     │   │
│  │  [💾 保存] [キャンセル]                             │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.6 削除確認ダイアログ（🗑️ 削除ボタン押下時）

```
┌─────────────────────────────────────────────────────────────┐
│  ⚠️ 削除確認                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  「Flexboxカードレイアウト（均等配置）」            │   │
│  │  を削除しますか？                                   │   │
│  │                                                     │   │
│  │  ※ この操作は取り消せません                         │   │
│  │  ※ Google Drive上のデータも削除されます             │   │
│  │                                                     │   │
│  │  [🗑️ 削除する] [キャンセル]                         │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.7 登録ページ

AI整形ボタン + AIチェックボタン搭載。content_type選択で表示形式を指定。

```
┌─────────────────────────────────────────────────────────────┐
│  📝 新規登録                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  タイトル *                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  カテゴリ *                     タイプ *                    │
│  [ HTML/CSS ▼ ]                 [● コード  ○ マニュアル ]   │
│                                                             │
│  説明文（ラフ入力OK）*                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ・横並びにする                                      │   │
│  │ ・gapを使う                                         │   │
│  │ ・レスポンシブ対応                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│  [✨ AI整形（2.0 Flash）] [🔍 AIチェック（3.0 Flash）]      │
│                                                             │
│  タグ（カンマ区切り）                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ flexbox, card, gap                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ─── コード（タイプが「コード」の場合のみ表示）───          │
│                                                             │
│  HTMLコード                     CSSコード                   │
│  ┌──────────────────────┐      ┌──────────────────────┐   │
│  │                      │      │                      │   │
│  └──────────────────────┘      └──────────────────────┘   │
│                                                             │
│  JavaScriptコード（任意）                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  参考画像                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📁 ファイルをドラッグ or クリック                  │   │
│  │     PNG, JPG, GIF（最大5MB）                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  補足・注意点                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [ ✅ Google Driveに保存して登録 ]                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.7.1 AIチェック結果表示（🔍 AIチェックボタン押下時）

```
┌─────────────────────────────────────────────────────────────┐
│  🔍 AIチェック結果                            [❌ 閉じる]  │
│  ───────────────────────────────────────────────────────── │
│                                                             │
│  ❌ 誤字発見:                                               │
│     「Flecbox」→「Flexbox」                                │
│     「レスポンシブル」→「レスポンシブ」                     │
│                                                             │
│  ⚠️ 内容確認:                                               │
│     「横並び配置」には gap プロパティも                     │
│     記載した方が良いかもしれません。                        │
│                                                             │
│  ✅ 問題なし:                                               │
│     コードの構文は正しいです。                              │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  [📝 修正を自動適用] [無視して続行]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.8 一覧ページ

```
┌─────────────────────────────────────────────────────────────┐
│  📋 登録データ一覧                              全 24 件    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  フィルタ: [ 全て ▼ ]    検索: [________________]          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ タイトル              │タイプ │カテゴリ │登録日 │操作│   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Flexboxカード配置     │コード │HTML/CSS │12/27 │編集│   │
│  │ 本社へのアクセス方法  │ﾏﾆｭｱﾙ │その他   │12/26 │編集│   │
│  │ CSS Gridレイアウト    │コード │HTML/CSS │12/25 │編集│   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [ < 前へ ]  1 / 3  [ 次へ > ]                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.9 サイドバー（課金状況表示）

全ページ共通でサイドバーに表示。API使用状況をリアルタイムで確認可能。

```
┌─────────────────────┐
│  🎨 RAG System      │
│                     │
│  ──────────────────│
│  📄 ページ          │
│  ├ 🔍 検索          │
│  ├ 📝 登録          │
│  └ 📋 一覧          │
│                     │
│  ──────────────────│
│  💰 今月の利用状況   │
│  ┌─────────────────┐│
│  │ 検索回答(Pro)   ││
│  │   42回 ≈ ¥63   ││
│  │                 ││
│  │ AI整形(2.0Flash)││
│  │   15回 ≈ ¥2    ││
│  │                 ││
│  │ AIチェック      ││
│  │ (3.0Flash)      ││
│  │   12回 ≈ ¥1    ││
│  │                 ││
│  │ ─────────────  ││
│  │ 合計: ≈ ¥66    ││
│  │ (12月)          ││
│  └─────────────────┘│
│                     │
│  [📊 詳細を見る]    │
│                     │
└─────────────────────┘
```

### 5.9.1 課金詳細ページ（📊 詳細を見るボタン押下時）

```
┌─────────────────────────────────────────────────────────────┐
│  💰 API使用状況 詳細                                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📅 期間: 2025年12月                                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ モデル               │ 回数  │ トークン  │ 概算費用 │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Gemini 3.0 Pro      │ 42回  │ 84,000   │ ¥63     │   │
│  │ (検索回答)           │       │          │         │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Gemini 3.0 Flash    │ 12回  │ 18,000   │ ¥1      │   │
│  │ (AIチェック)         │       │          │         │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Gemini 2.0 Flash    │ 15回  │ 22,500   │ ¥2      │   │
│  │ (AI整形)             │       │          │         │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Gemini Embedding    │ 57回  │ 28,500   │ ¥0      │   │
│  │ (ベクトル化)         │       │          │ (無料)  │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 合計                │ 126回 │ 153,000  │ ¥66     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  📈 日別推移グラフ                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │     ▂                                               │   │
│  │   ▄ █ ▂   ▂                                        │   │
│  │ ▂ █ █ █ ▄ █ ▂                                      │   │
│  │ 1  5  10  15  20  25                     (日付)    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ⚠️ 月額目安: ¥200以下 なら正常範囲                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 処理フロー

### 6.1 起動・同期フロー

Streamlit Cloudのデータ消失対策として、起動時にDriveからデータを取得。

```
1. アプリ起動
      ↓
2. Google Driveから practices.json をダウンロード
      ↓
3. ローカルの data/practices.json に保存（キャッシュ）
      ↓
4. ChromaDBを再構築（ベクトルデータ生成）
      ↓
5. 検索準備完了
```

### 6.2 検索フロー

```
1. ユーザーが質問を入力 + カテゴリ選択
   「横並びのカードを均等に配置したい」（カテゴリ: HTML/CSS）
      ↓
2. Gemini Embeddingでベクトル化
   [0.12, -0.45, 0.78, ...] (768次元)
      ↓
3. ChromaDBで類似検索（カテゴリでフィルタ）
   → 上位3件のデータを取得
      ↓
4. Gemini 3.0 Proに送信
   プロンプト:
   「以下の参考情報を元に質問に回答してください。
    参考1: ...
    参考2: ...
    参考3: ...
    質問: 横並びのカードを均等に配置したい」
      ↓
5. AIの回答 + 参考データカードを表示
```

### 6.3 登録フロー

```
1. フォームに入力
      ↓
2. (任意) AI整形ボタン → Gemini 2.0 FlashでMarkdown化
      ↓
3. [登録] ボタン押下
      ↓
4. 画像があればGoogle Driveへアップロード
      ↓
5. practices.jsonを更新 → Google Driveへ上書き保存（永続化）
      ↓
6. ChromaDBに追加登録（即時検索対応）
      ↓
7. 完了メッセージ表示
```

### 6.4 インライン編集フロー

```
1. 検索結果カードの [✏️ 編集] ボタン押下
      ↓
2. その場で編集モードに切り替え（モーダル表示）
      ↓
3. 内容を修正
      ↓
4. [💾 保存] ボタン押下
      ↓
5. Google Driveのpractices.jsonを更新
      ↓
6. ChromaDBのベクトルを再生成（説明文が変わった場合）
      ↓
7. 画面を更新して反映
```

---

## 7. API仕様

### 7.1 Gemini Embedding

```python
import google.generativeai as genai

genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))

def get_embedding(text: str) -> list[float]:
    """テキストをベクトル化（768次元）"""
    result = genai.embed_content(
        model="models/text-embedding-004",
        content=text
    )
    return result['embedding']
```

### 7.2 Gemini 3.0 Pro（回答生成）

```python
def generate_answer(question: str, contexts: list[dict]) -> str:
    """検索結果を元にAI回答を生成"""
    model = genai.GenerativeModel("gemini-3.0-pro")
    
    # コンテキスト整形
    context_text = ""
    for i, ctx in enumerate(contexts, 1):
        context_text += f"""
【参考{i}】{ctx['title']}
タイプ: {ctx['content_type']}
説明: {ctx['description']}
"""
        if ctx['content_type'] == 'code':
            context_text += f"HTML: {ctx.get('code_html') or 'なし'}\n"
            context_text += f"CSS: {ctx.get('code_css') or 'なし'}\n"
    
    prompt = f"""あなたはHTML/CSS/プログラミングの実装エキスパートです。
以下の参考情報を元に、質問に対して具体的に回答してください。
コードが関係する場合は、具体的なコード例を含めてください。

{context_text}

質問: {question}

回答:"""
    
    response = model.generate_content(prompt)
    return response.text
```

### 7.3 Gemini 2.0 Flash（AI整形）

```python
def format_to_markdown(raw_text: str) -> str:
    """箇条書きメモをMarkdownに整形"""
    model = genai.GenerativeModel("gemini-2.0-flash")
    
    prompt = f"""以下のメモを、読みやすいMarkdown形式に整形してください。
- 見出し（##）を適切に使用
- 箇条書きや番号リストを活用
- 重要な部分は**太字**に
- 元の情報を省略せず、すべて含める

メモ:
{raw_text}

整形後:"""
    
    response = model.generate_content(prompt)
    return response.text
```

### 7.4 Gemini 3.0 Flash（AIチェック）

```python
def check_content(title: str, description: str, code: str = None) -> dict:
    """誤字脱字・内容確認チェック"""
    model = genai.GenerativeModel("gemini-3.0-flash")
    
    content = f"""タイトル: {title}
説明文: {description}
"""
    if code:
        content += f"コード: {code}"
    
    prompt = f"""以下の内容をチェックしてください。

{content}

以下の形式でJSON形式で回答してください:
{{
  "typos": [
    {{"original": "誤った文字列", "corrected": "正しい文字列"}}
  ],
  "suggestions": [
    "改善提案があれば記載"
  ],
  "code_issues": [
    "コードに問題があれば記載"
  ],
  "is_valid": true または false
}}

チェック結果:"""
    
    response = model.generate_content(prompt)
    return parse_json_response(response.text)
```

### 7.5 API使用量トラッキング

```python
import json
from datetime import datetime
from pathlib import Path

class UsageTracker:
    """API使用量を記録・集計"""
    
    def __init__(self, log_file: str = "data/usage_log.json"):
        self.log_file = Path(log_file)
        self.load_log()
    
    def load_log(self):
        """ログファイル読み込み"""
        if self.log_file.exists():
            with open(self.log_file, 'r') as f:
                self.log = json.load(f)
        else:
            self.log = {"records": []}
    
    def record(self, model: str, tokens: int, action: str):
        """使用記録を追加"""
        record = {
            "timestamp": datetime.now().isoformat(),
            "model": model,
            "tokens": tokens,
            "action": action  # "search", "format", "check", "embedding"
        }
        self.log["records"].append(record)
        self.save_log()
    
    def save_log(self):
        """ログファイル保存"""
        with open(self.log_file, 'w') as f:
            json.dump(self.log, f, indent=2)
    
    def get_monthly_summary(self, year: int, month: int) -> dict:
        """月別サマリーを取得"""
        # 料金設定（1Mトークンあたり）
        PRICING = {
            "gemini-3.0-pro": {"input": 2.0, "output": 12.0},
            "gemini-3.0-flash": {"input": 0.5, "output": 3.0},
            "gemini-2.0-flash": {"input": 0.1, "output": 0.4},
            "text-embedding-004": {"input": 0, "output": 0}  # 無料
        }
        
        summary = {}
        for record in self.log["records"]:
            dt = datetime.fromisoformat(record["timestamp"])
            if dt.year == year and dt.month == month:
                model = record["model"]
                if model not in summary:
                    summary[model] = {"count": 0, "tokens": 0, "cost": 0}
                summary[model]["count"] += 1
                summary[model]["tokens"] += record["tokens"]
                # 概算コスト計算（input:outputを50:50と仮定）
                price = PRICING.get(model, {"input": 0, "output": 0})
                avg_price = (price["input"] + price["output"]) / 2
                summary[model]["cost"] += (record["tokens"] / 1_000_000) * avg_price
        
        return summary
```

### 7.6 Google Drive連携

```python
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload

class DriveManager:
    def __init__(self):
        self.service = self._authenticate()
        self.folder_id = os.getenv("GOOGLE_DRIVE_FOLDER_ID")
    
    def _authenticate(self):
        """Google Drive API認証"""
        # Streamlit Cloudではst.secretsを使用
        creds = Credentials.from_authorized_user_info(...)
        return build('drive', 'v3', credentials=creds)
    
    def download_json(self, filename: str) -> dict:
        """JSONファイルをダウンロード"""
        # 実装
        pass
    
    def upload_json(self, filename: str, data: dict):
        """JSONファイルをアップロード（上書き）"""
        # 実装
        pass
    
    def upload_image(self, local_path: str) -> str:
        """画像をアップロードしてURLを返す"""
        # 実装
        pass
    
    def delete_image(self, file_id: str):
        """画像を削除"""
        # 実装
        pass
```

---

## 8. 環境変数

### 8.1 .env（ローカル開発用）

```
# Gemini API
GOOGLE_API_KEY=your_gemini_api_key_here

# Google Drive
GOOGLE_DRIVE_FOLDER_ID=your_folder_id_here
GOOGLE_DRIVE_CREDENTIALS={"type": "service_account", ...}
```

### 8.2 Streamlit Cloud Secrets（デプロイ用）

```toml
# .streamlit/secrets.toml
GOOGLE_API_KEY = "your_gemini_api_key_here"
GOOGLE_DRIVE_FOLDER_ID = "your_folder_id_here"

[GOOGLE_DRIVE_CREDENTIALS]
type = "service_account"
project_id = "your_project_id"
private_key_id = "..."
private_key = "-----BEGIN PRIVATE KEY-----\n..."
client_email = "..."
# ... その他の認証情報
```

---

## 9. Google Drive フォルダ構成

```
Google Drive/
└── RAG-BestPractices/          ← GOOGLE_DRIVE_FOLDER_ID で指定
    ├── practices.json          ← データ本体
    └── images/
        ├── card-layout.png
        ├── access-map.png
        └── ...
```

---

## 10. 依存パッケージ（requirements.txt）

```
streamlit>=1.28.0
chromadb>=0.4.0
google-generativeai>=0.3.0
python-dotenv>=1.0.0
Pillow>=10.0.0

# Google Drive連携
google-api-python-client>=2.0.0
google-auth-httplib2>=0.1.0
google-auth-oauthlib>=1.0.0
```

---

## 11. エラーハンドリング

### 11.1 Google Drive接続失敗時

```python
try:
    data = drive_manager.download_json("practices.json")
except Exception as e:
    st.warning("⚠️ Google Driveに接続できません。ローカルキャッシュを使用します。")
    data = load_local_cache()
```

### 11.2 API制限・エラー時

```python
import time
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
def call_gemini_api(prompt: str):
    """リトライ付きAPI呼び出し"""
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        st.error(f"API呼び出しエラー: {e}")
        raise
```

### 11.3 画像アップロード失敗時

```python
try:
    image_url = drive_manager.upload_image(uploaded_file)
except Exception as e:
    st.error(f"❌ 画像のアップロードに失敗しました: {e}")
    image_url = None  # 画像なしで登録を続行
```

---

## 12. 実装フェーズ

### Phase 1: 基本機能開発（ローカル）
- [ ] プロジェクト作成・環境構築
- [ ] ChromaDB + Embedding動作確認
- [ ] 検索機能（テストデータ3件）
- [ ] AI回答表示（Gemini 3.0 Pro）
- [ ] 登録機能（AI整形付き）
- [ ] 可変レイアウト（code/manual切り替え）
- [ ] practices.json（ローカル）での動作確認

### Phase 2: クラウド連携（Google Drive）
- [ ] GCPプロジェクト作成
- [ ] Drive API有効化・認証設定
- [ ] データの読み書きをDrive経由に変更
- [ ] 画像のDrive保存実装
- [ ] 起動時の同期処理実装

### Phase 3: 管理機能 + デプロイ
- [ ] 一覧ページ実装
- [ ] **検索結果からのインライン編集**
- [ ] **検索結果からの画像追加**
- [ ] **検索結果からの削除**
- [ ] カテゴリフィルタ機能
- [ ] Streamlit Cloud設定
- [ ] Secrets設定（APIキー等）
- [ ] 動作確認・本番デプロイ

### Phase 4: 拡張（将来）
- [ ] エクスポート/インポート機能
- [ ] データバックアップ自動化
- [ ] 検索履歴・お気に入り機能
- [ ] 複数ユーザー対応

---

## 13. 注意事項

### セキュリティ
- APIキーは絶対にGitHubにプッシュしない
- `.env` は `.gitignore` に必ず追加
- Streamlit Cloudでは Secrets 機能を使用
- Google Drive認証情報は安全に管理

### コスト目安
| 項目 | コスト |
|------|--------|
| Gemini Embedding | 無料枠内 |
| Gemini 3.0 Pro | 約1.5円/回 |
| Gemini 2.0 Flash | 約0.1円/回 |
| Google Drive | 無料（15GB） |
| Streamlit Cloud | 無料 |

**月100回使用: 約150〜200円**

### 制限事項
- 画像は5MB以下推奨
- 1回の検索で参照するデータは最大5件
- 説明文は500文字以内推奨（Embedding精度のため）
- Streamlit Cloud無料枠: 1GB RAM、共有CPU

---

## 14. 次のアクション

1. **この仕様書を保存**
2. **Google AI StudioでAPIキー確認**
3. **Claude Codeでプロジェクト作成開始**
   ```
   mkdir rag-best-practices
   cd rag-best-practices
   ```
4. **Phase 1から実装**

---

## 15. 追加機能仕様（v7.0）

### 15.1 セクション別図解生成

AI回答を見出し（`##`）で分割し、各セクションごとに図解生成を可能にする。

#### 画面イメージ
```
🤖 AIの回答:
┌─────────────────────────────────────────┐
│ ## 1. Flexの基本機能                     │
│ Flexは横並びにする機能です...            │
│                          [📐 図解生成]   │
├─────────────────────────────────────────┤
│ ## 2. Flexの応用                         │
│ flex-wrapで折り返しも...                │
│                          [📐 図解生成]   │
├─────────────────────────────────────────┤
│ ## 3. 複雑なレイアウト                   │
│ ネストしたFlexboxで...                  │
│                          [📐 図解生成]   │
└─────────────────────────────────────────┘
           [📐 全体の図解生成]  ← 既存機能（残す）
```

#### 実装方針
- AI回答テキストを `##` で分割
- 各セクションをexpanderまたはカードで表示
- セクションごとに `generate_preview_svg()` を呼び出し
- 既存の「全体図解」ボタンも維持

---

### 15.2 記憶ページ（学習支援機能）

登録データを学習・暗記するための専用ページ。

#### 画面イメージ
```
┌─────────────────────────────────────────────────────┐
│ 🧠 記憶                                              │
├─────────────────────────────────────────────────────┤
│ 🔍 [毎日のルーティーン              ] [検索]         │
├─────────────────────────────────────────────────────┤
│ ▼ 検索結果（5件）                                    │
│ ☐ 朝のストレッチ手順    [📐 図解] [➕ 学習に追加]    │
│ ☐ 夜の振り返り         [📐 図解] [➕ 学習に追加]    │
├─────────────────────────────────────────────────────┤
│ [📚 未学習 (3)] [✅ 覚えた (2)]                      │
│ 進捗: ████████░░ 60% (3/5件)                        │
├─────────────────────────────────────────────────────┤
│ □ 朝のストレッチ手順                                 │
│   起床後5分で行う基本ストレッチ...（先頭100文字）    │
│   [📐 図解] [📖 詳細] [✅ 覚えた]                    │
└─────────────────────────────────────────────────────┘
```

#### データ構造
```json
// data/learning_progress.json
{
  "items": [
    {
      "practice_id": "uuid-xxx",
      "status": "pending",      // pending/learned
      "added_at": "2025-01-01T10:00:00",
      "learned_at": null,
      "notes": ""
    }
  ]
}
```

#### 機能一覧
- 検索 → 学習リストに追加
- タブ切り替え（未学習/覚えた）
- 進捗表示（バー + パーセント）
- 一覧内に図解生成ボタン
- 詳細表示（先頭100文字 + 詳細ボタン）
- 「覚えた」のチェックを外す → 未学習に戻る

---

### 15.3 コード学習ページ

HTML/CSSのサンプルコードを登録し、特定部分について質問・図解生成する機能。

#### 現在の実装状態（2025-12-29更新）

**✅ 実装済み**
- サイドバー非表示 + 上部ナビゲーション
- プレビュー画像（折りたたみ式）
- HTML表示（折りたたみ式、st_aceで色付き）
- CSS表示（常時表示、st_aceで色付き）
- 質問チャット機能（履歴対応）
- 図解生成（チャット回答ごと）
- 保存済みデータの読み込み

**❌ 未解決の問題**
1. **st_aceの値取得問題**: エディタに入力した値が保存時に取得できない
2. **HTML/CSS分離問題**: 読み込み時に両方同じ値になることがある

#### 現在の画面構成
```
+----------------------------------------------------------+
| 🔍検索 | 📋一覧 | ⚙️設定 | 💾保存済み |                    | ← 上部ナビ
+----------------------------------------------------------+
| [📷 プレビュー画像（折りたたみ）]                          |
|   └ 画像アップロード / クリップボード貼り付け              |
+----------------------------------------------------------+
| [📄 HTML（折りたたみ）]                                   |
|   └ st_ace (monokai theme) で色付き表示                  |
+----------------------------------------------------------+
| 🎨 CSS (60%)              | 💬 質問 (40%)               |
| ┌──────────────────────┐  | ┌──────────────────────┐   |
| │ st_ace (monokai)     │  | │ 質問入力             │   |
| │                      │  | │ [🤖質問] [🗑️クリア]  │   |
| │                      │  | │ ─────────────────── │   |
| └──────────────────────┘  | │ チャット履歴         │   |
|                          | │ Q: ...               │   |
|                          | │ A: ...               │   |
|                          | │ [📐 図解生成]        │   |
|                          | └──────────────────────┘   |
+----------------------------------------------------------+
| タイトル | カテゴリ | 💾保存 | 🗑️クリア                  |
+----------------------------------------------------------+
| [🐛 デバッグ（折りたたみ）]                                |
+----------------------------------------------------------+
```

#### 依存パッケージ
```
streamlit-ace>=0.1.1     # 色付きコードエディタ
streamlit-paste-button   # クリップボード画像貼り付け
```

#### 技術的な問題と対策

**問題1: st_aceがNoneを返す**
```python
# 現在のコード
html_input = st_ace(value=html_val, key=f"html_ace_{ace_counter}")
# → html_inputがNoneになることがある

# 対策案
# 1. st.text_areaに戻して動作確認
# 2. keyを固定にする（動的生成しない）
# 3. session_stateで値を明示的に管理
```

**問題2: HTML/CSS分離**
```python
# データ構造
{
    "code_html": "HTMLコード",
    "code_css": "CSSコード"  # 別フィールドで保存
}

# 読み込み時の処理
html_part = p.get("code_html", "")
css_part = p.get("code_css", "")
# → 過去のバグで同じ値が入っている場合がある
```

#### 次のアクション
1. st_aceをst.text_areaに一時的に戻す
2. 保存機能が動くことを確認
3. st_aceの問題を調査・修正
4. 壊れた既存データを修正

#### 旧仕様（将来実装予定）
```
┌─────────────────────────────────────────────────────┐
│ 📦 自動分割されたセクション                          │
│ ☐ [HTML] headerセクション (1-15行)                  │
│ ☑️ [HTML] cardコンポーネント (16-45行)               │
├─────────────────────────────────────────────────────┤
│ 手動で範囲指定:                                      │
│ HTML: [====●========] 16 〜 [========●====] 45      │
│       ▼ プレビュー                                  │
│       <div class="card">...</div>                   │
└─────────────────────────────────────────────────────┘
```

#### データ構造（practices.jsonに統合）
```json
// コード学習データはpractices.jsonに保存（tags: ["コード学習"]）
{
  "id": "uuid-xxx",
  "title": "Flexboxサンプル",
  "category": "html_css",
  "content_type": "code",
  "tags": ["コード学習"],
  "code_html": "<!DOCTYPE html>...",
  "code_css": ".card { display: flex; }...",
  "image_path": "data/images/flexbox-demo.png",
  "notes": "[{\"title\": \"全体\", \"start_line\": 1, ...}]",  // JSON文字列でセクション保存
  "created_at": "2025-01-01T10:00:00",
  "updated_at": "2025-01-01T10:00:00"
}
```

#### 機能一覧
- ✅ HTML/CSS/画像の登録フォーム
- ✅ コードと画像を見ながら質問
- ✅ 質問履歴（会話形式）
- ✅ 回答ごとに図解生成
- ❌ AI自動分割（セクション化）← 未実装
- ❌ スライダーで行範囲選択 ← 未実装
- ❌ URL入力 → HTML/CSS自動取得 ← 将来

---

## 16. 実装フェーズ（更新）

### Phase 1: 基本機能開発（ローカル）✅ 完了
- [x] ChromaDB + Embedding動作確認
- [x] 検索機能 + AI回答表示
- [x] 登録機能
- [x] 図解生成・保存機能
- [x] 永続キャッシュ

### Phase 2: 機能拡張 ← 現在
- [ ] **A. セクション別図解生成**
- [ ] **C. コード学習ページ**
- [ ] **B. 記憶ページ**

### Phase 3: クラウド連携
- [ ] Google Drive同期
- [ ] Streamlit Cloudデプロイ

### Phase 4: 拡張（将来）
- [ ] URL自動取得（コード学習）
- [ ] エクスポート/インポート機能
- [ ] 複数ユーザー対応

---

作成日: 2025-12-27
更新日: 2025-12-29
バージョン: v7.1
作成者: Claude + Sensha

---

## 17. 既知の問題・トラブルシューティング

### 17.1 コード学習ページ（7_📖_コード学習.py）

| 問題 | 状態 | 原因 | 対策 |
|------|------|------|------|
| タイトルフリッカー | ✅解決 | session_state更新による無限rerun | 更新処理を削除 |
| 保存機能動作しない | ❌未解決 | st_aceがNone返す | st.text_areaに戻す |
| HTML/CSS分離不正 | ❌未解決 | 過去のバグでデータ破損 | データ手動修正 |

### 17.2 依存パッケージの注意

```
google.generativeai  # 非推奨警告あり → google.genaiへ移行予定
streamlit-ace        # 値取得に問題あり → 調査中
```
